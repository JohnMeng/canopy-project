<html>

<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="index.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,700|ABeeZee|Titillium+Web:200,300,400,700' rel='stylesheet' type='text/css'>
    <link href='apidocs.css' rel='stylesheet' type='text/css'>
</head>

<body>
<div class=main>
    <h1>Canopy Embedded Tutorial</h1>
    <p>
        <a href=#intro>Introduction</a><br>
        <a href=#install>1) Install the Canopy Embedded Toolchain</a><br>
        <a href=#describe>2) Describe your device</a><br>
        <a href=#generate>3) Generate embedded code using "cano gen"</a><br>
        <a href=#customize>4) Customize the C code for this particular device</a><br>
        <a href=#provisioning>5) Provisioning</a><br>
        <a href=#start>6) Start the program</a><br>
        <a href=#where_to_go_from_here>Where to go from here</a><br>
    </p>

    <h2><a name=intro>Introduction</a></h2>
    <p>
        Canopy makes it simple to develop IoT devices.  In this tutorial, we
        will show you how to remotely monitor and control a Raspberry Pi with
        just a few lines of code.  Specifically, we will monitor the CPU usage
        of the Pi, and also be able to remotely reboot the device.
    </p>
    <p>
        The principal is simple: You describe the capabilities of your "smart
        device" in a language called SDDL.  Canopy uses this description file
        and does a bunch of work for you:
        <ol>
            <li>automatically generates embedded code that talks to the cloud, </li>
            <li>dynamically generates a server-side REST API, and </li>
            <li>dynamically generates a web UI for your device.</li>
        </ol>
    </p>
    <p>
        You <i>will</i> need to write a small amount of embedded code specific
        to your device (unfortunately Canopy can't do <i>everything</i> for
        you), but don't worry, we'll walk you through this.  You may also
        choose to build a customized frontend if you don't like the default UI.
    </p>
    <p>
        This tutorial has been tested on a Model B Raspberry Pi with Raspbian
        OS.  This tutorial will probably work equally well on any linux-based
        computer, including desktops and servers, but has not been tested on
        those platforms.
    </p>

    <h2><a name=install>0) Install prerequisites</a></h2>
    <p>
        Canopy requires libwebsockets.  To build and install libwebsockets from
        source, execute these commands on your Pi:
    </p>
    <div class=code>sudo apt-get install cmake zlib1g-dev libssl-dev rpm g++
git clone git://git.libwebsockets.org/libwebsockets
cd libwebsockets
mkdir build
cd build
cmake ..
make
sudo make install
cd ../../
</div>

    <h2><a name=install>1) Install the Canopy Embedded Toolchain</a></h2>
    <p>
        From the commandline on your Pi: 
    </p>
    <div class=code>git clone https://github.com/canopy-project/canopy-embedded
cd canopy-embedded
make
sudo make install</div>
    <p>
        To test that the Canopy Embedded Toolchain was installed correctly,
        run:
    </p>
    <div class=code>cano test</div>
    <p>
        After a short amount of time, you should see output along the lines of:
    </p>
    <div class=code>cano PASSED.  2 subtests.
All tests passed.</div>

    <h2><a name=describe>2) Describe your device</a></h2>
    <p>
        Next, we must provide Canopy with a description of our device, using
        the Smart Device Description Language.
    </p>
    <p>
        In this tutorial, we will monitor the CPU usage of our Raspberry Pi,
        and also allow it to be remotely rebooted.  In SDDL terminology, our
        device has one "control" and one "sensor".
    </p>
    <p>
        First, make a directory for our code:
    </p>
    <div class=code>mkdir ~/tutorial</code>
cd tutorial</div>

    <p>
        Now create a file <code>tutorial.sddl</code> in that directory, using
        the text editor of your choice:
    </p>
    <div class=code>/* tutorial.sddl */ 
{
    "class canopy.tutorial.sample_device_1" : { 
        "sensor cpu" : { 
            "datatype" : "float32", 
            "min-value" : 0.0, 
            "max-value" : 1.0, 
            "description" : "CPU usage percentage"
        }, 
        "control reboot" : {
            "control-type" : "trigger", 
            "datatype" : "void",
            "description" : "Reboots the device"
        } 
    } 
}</div>
    <h2><a name=generate>3) Generate embedded code using "cano gen"</a></h2>
    <p>
        The <code>cano</code> tool will generate embedded C code from the
        SDDL file.
    </p>
    <div class=code>cano gen tutorial.sddl</div>
    <p>
        This will generate three files: <code>sample_device_1.h</code>, <code>sample_device_1.c</code>, and <code>makefile</code>.
    </p>
    <p>
        The file <code>sample_device_1.h</code> contains boilerplate code that should not be modified.
    </p>
    <p>
        The file <code>sample_device_1.c</code> contains stub routines that we
        must hand-edit.
    </p>
    
    <h2><a name=customize>4) Customize the C code for this particular device</a></h2>
    <p>
        If you look at <code>sample_device_1.c</code> you will see that it
        contains this stub:
    </p>
    <div class=code>static bool on_trigger__reboot(CanopyContext canopy)
{
    /* Your code here 
     * Return true on success
     */
    return false;
}</div>
    <p>
    This function will be called on the device when a reboot is triggered from
    the cloud.  It should return <code>true</code> on success.  Let's implement
    it, shall we?
    </p>

    <div class=code>#include &lt;sys/reboot.h&gt;

...

static bool on_trigger__reboot(CanopyContext canopy)
{
    return (reboot(RB_AUTOBOOT) == 0);
}</div>
    <p>
    That's all we need to reboot device.
    </p>
    <p>
    For reporting CPU usage, a little more code is needed.  This time, we will
    modify the stub:
    </p>
    <div class=code>static bool on_report_requested(CanopyContext canopy)
{
    CanopyReport report = canopy_begin_report(canopy);

    /* Your code here */
    /* canopy_report_float32(report, "cpu", 0); */

    canopy_send_report(report);
    return true;
}</div>

    <p>This routine will be called periodically, about once every 10 seconds.
    Each time it is called, we will report the current CPU usage to the cloud.
    Change the implementation to this:</p>

    <div class=code>static bool on_report_requested(CanopyContext canopy)
{
    CanopyReport report = canopy_begin_report(canopy);

    FILE *fp;
    float val;

    /* Read current CPU usage */
    fp = fopen("/proc/loadavg", "r");
    if (!fp)
        return false;
    fscanf(fp, "%f", &amp;val);
    fclose(fp);

    /* Report it to the cloud */
    canopy_report_float32(report, "cpu", val);

    canopy_send_report(report);
    return true;
}</div>
    <p>
        Now, compile the program:
    </p>
    <div class=code>make</div>
    <p>
        If all goes well, the program <code>sample_device_1</code> will be created.
    </p>

    <h2><a name=provisioning>5) Provisioning</a></h2>
    <p>
        We're almost done.  One last thing to do is to create a Canopy account
        (if you haven't already) and associate this device with that account.
    </p>
    <p>
        Go to <a
        href='http://canopy.link/go.php' target=_blank>http://canopy.link/go.php</a> and sign
        up, if you haven't done so already.
    </p>
    <p>
        Now, go back to the device's command line, and run:
    </p>
    <div class=code>cano provision</div>
    <p>
        When prompted, enter your Canopy username and password.
    </p>
    <h2><a name=start>6) Start the program</a></h2>
    <p>
        Now, just run:
    </p>
    <div class=code>./sample_device_1</div>
    <p>
        If everything went well, you can now reboot this device and monitor
        it's CPU usage from anywhere.  Additionally, you can share this device
        with your friends.
    </p>
    <p>
        Go to <a
        href='http://canopy.link/go.php'
        target=_blank>http://canopy.link/go.php</a> to see your device.
    </p>
    <p>
        If you want the <code>sample_device_1</code> program to start
        automatically after boot, simply add this line to <code>/etc/rc.local</code>:
    </p>
    <div class=code>/home/pi/tutorial/sample_device_1 &amp;</div>

    <h2><a name=where_to_go_from_here>Where to go from here</a></h2>
    <p>Congrats!  You've created your first smart device using Canopy.
    Hopefully you found it easy.</p>

    <p>
        Now that you've mastered the basics, here are some ideas to try next:
        <ul>
            <li>
                Control peripherals from the web using the Pi's GPIO pins and
                <a href=http://wiringpi.com/ target=_blank>Wiring Pi</a>.
            </li>
            <li>
                Create a custom frontend using the <a href=rest_api.html>Canopy
                REST API</a>.
            </li>
            <li>
                Deploy your own instance of Canopy Cloud server.
            </li>
        </ul>
    </p>
    <br>
    <br>
    <p>
        <center>
        The content of this page is licensed under the Creative Commons Attribution 3.0 License, and code is licensed under a BSD license.
    </p>
    <br>
    <br>
</div>
</body>
</html>
